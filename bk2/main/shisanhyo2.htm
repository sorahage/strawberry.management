<?php
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');

echo '<link rel="stylesheet" href="table.css">';
echo '<link rel="stylesheet" href="simple.css">';


//科目読込
$sql  = 'SELECT no,name,bunrui FROM kamoku WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$kamoku[$row['no']]=$row['name'  ];
	$bunrui[$row['no']]=$row['bunrui'];
}

//部門読込
$sql  = 'SELECT no,name FROM bumon WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$bumon[$row['no']]=$row['name'  ];
}


//選択メニュー表示
$y=15; $m=1;
while($y<17){
	echo '<a href="?y='.$y.'&d=0">20'.$y.'</a> | ';
	while($m<14){
		echo '<a href="?y='.$y.'&d='.$m.'">'.$m.'月</a> ';
		$m++;
	}
	$y++;$m=1;
	echo '<br><br>';

}


echo '<a href="?d=-1">法人集計 1509-0608</a><br><br>';

//部門選択表示
$b=$_POST['bumon'];

echo '<form action="';
echo (empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
echo '" method="post" name="bs">';

echo '部門：<select name="bumon" onChange="kakunin()">';

foreach($bumon as $key => $value){
	echo'<option value="'.$key.'"';
	if($b==$key){echo' selected';}
	echo'>'.$key.' '.$value.'</option>';
}

echo'</select><input name="Go" type="submit"></form>';


//データセット
$year=$_GET['y'];
$d=$_GET['d'];

if($year==0){$year=16;}

$date1=$year*10000+$d*100;
$date2=$date1+99;
//$date2=$date1;
if($d==0){$date1=$year*10000+100;$date2=$date1+1200;}
echo $date1.'-'.$date2;
//if($d==-1){$date1=150900;$date2=160900;}

echo ' <a href="./"><--</a> ';
echo '＜ '.floor($date1/100).'-'.floor($date2/100).' 試算表 ＞<br>';
echo '<table border=1 class="sample">';

//金額リセット
$yokin=0;








//$retu ... 列
//$retu_name [0-x]
//$retu_kaiso[0-4]

//BeforeBumon初期値を算入
//$i=0;while($i<5){$bb[$i]=-1;$i++;}
$bb[0]=-1;//1桁目で確認できるので、1桁目のみ数値代入

//$retu_name[x]='列名'
//$retu_kaiso[x]='列名'
//$retu_name[x]='列名'
$retusu	   = 0;//列数リセット
$kaiso     = 3;//現在処理中の階層
$c_bumon[0]=-1;//現在処理中の列に初期値を算入
$c_bumon[1]=-1;//現在処理中の列に初期値を算入
$c_bumon[2]=-1;//現在処理中の列に初期値を算入
$bumonsu[0]= 0;//部門数をリセット 大部門 法人、個人
$bumonsu[1]= 0;//部門数をリセット 中部門 部門
$bumonsu[2]= 0;//部門数をリセット 少部門 物件

//部門を列に置き換え
foreach($bumon as $no => $name){

	if($no==floor($no/10000)*10000){
		echo '<td align="center">'.$no.'<br>'.$name;
	}
}








/*
	//桁ごとの数値を取得
	$i=0;//桁数カウント
	while($i<5){
		$b[$i]=substr($no,$i,1);
		if($b[$i]==''){$b[$i]=0;}//数値がゼロの場合の対応
		$i++;
	}

	//部門コードと部門名を表示
	$i=0;//桁数カウント
	while($i<5){
		echo $b[$i];
		$i++;
	}
	echo '|'.$name.'<br>';

	//部門コードの増減を確認
	$i=0;while($i<3){if($bb[$i]>$b[$i]){break;}$i++;}

	//処理階層が上がった場合
	if($kaiso<$i){

		//直前に処理されていた部門階層の合計を列へ追加
		if($bumonsu[$kaiso]>1){
			
			
	//処理階層が下がった場合
	}elseif($kaiso<$i){
		

	if($b[0]==$c_bumon[0]){$bumonsu[0]++;}
	if($b[1]==$c_bumon[1]){$bumonsu[1]++;}
	if($b[2]==$c_bumon[2]){$bumonsu[2]++;}

	//処理中の部門か確認
	if($i==$c_retu){
		$bumonsu++;//部門数をカウント
	}else{
		$bumonsu=0;//部門数をリセット


	if($b[1]==0 and $b[2]==0 and $b[3]==0 and $b[4]==0){$bumon0[$b[0]]=$name;}
	if(             $b[2]==0 and $b[3]==0 and $b[4]==0){$bumon1[$b[1]]=$name;}
	if(                          $b[3]==0 and $b[4]==0){$bumon2[$b[2]]=$name;}



	//
	$i0=floor($no/10000)*10000;
	if($no==$i0){$bumon1[$i0]=$name;}

	$i1=floor($no/ 1000)-$i0*10;
	if($no==$i0){$bumon1[$i0]=$name;}
	

/*
	$b[0]=floor($no)/10000;
	$b[1]=floor($no)/ 1000-$b[0];
	$b[2]=floor($no)/  100;
	$b[3]=floor($no)/   10;
	$b[4]=floor($no)      ;
*/

/*

foreach ($kamoku as $key => $value) {

	if($key>149 and $before_key<150){
		echo '<tr><td align="right"><b>預金計'.
		     '<td align="right"><b>'.number_format($yokin_kisyu).
		     '<td align="right"><b>'.number_format($yokin_kari ).
		     '<td align="right"><b>'.number_format($yokin_kashi).
		     '<td align="right"><b>'.number_format($yokin_zan  );
	}

	echo '<tr><td>'.sprintf("%03d", $key).' '.$value;

	//期首残読込
	$d0=floor($date1/100)-1;//前月末の残高を取得
	//$d00=$d0-floor($d0/100)*100;//月を取得
	if($d<2){$d0-=87;}
	echo'['.$d0.']';
	$sql  = 'SELECT sum(kingaku) FROM zan WHERE kamoku='.$key.' and date='.$d0;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kisyu=$row['sum(kingaku)'];

	//期末残読込
	$d0=floor($date2/100);
	echo'['.$d0.']';
	$sql  = 'SELECT sum(kingaku) FROM zan WHERE kamoku='.$key.' and date='.$d0;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$zan=$row['sum(kingaku)'];

	//借方集計
	$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kari ='.$key.' and date>'.$date1.' and date<'.$date2;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kari=$row['sum(kingaku)'];	

	//貸方集計
	$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kashi='.$key.' and date>'.$date1.' and date<'.$date2;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kashi=$row['sum(kingaku)'];

	
	if($bunrui[$key]>1 and $bunrui[$key]<5){
		$zan=$kisyu-$kari+$kashi;
	}else{
		$zan=$kisyu+$kari-$kashi;
	}
	

	// 現預金計
	if($key>001 and $key<150){
		$yokin_kisyu+=$kisyu;
		$yokin_kari +=$kari ;
		$yokin_kashi+=$kashi;
		$yokin_zan  +=$zan  ;
	}

	echo '<td align="right">'.number_format($kisyu).'<td align="right">'.number_format($kari).
	     '<td align="right">'.number_format($kashi).'<td align="right">'.number_format($zan );

	// 直前の科目番号を代入
	$before_key=$key;
	//echo'<td>'.$before_key;
}
*/
