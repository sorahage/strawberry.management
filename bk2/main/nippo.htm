<?php
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');

//部門読込
$sql  = 'SELECT no,name FROM bumon WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$bumon[$row['no']]=$row['name'  ];
}
end($bumon);
$bumon_end_key=key($bumon);
reset($bumon);

//担当読込
$sql  = 'SELECT no,name FROM tanto WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$tanto[$row['no']]=$row['name'  ];
}

//データセット
$m1=$_GET['m1'];//開始期間
$m2=$_GET['m2'];//終了期間
$k=$_GET['k'];//表示分類
$b1=$_GET['b1'];//開始部門
$b2=$_GET['b2'];//終了部門

//初期値セット
if($m1==""){$m1=date('y').date('m').'00';}
if($m2==""){$m2=date('y').date('m').'99';}
if($k ==""){$k=0;}
if($b1==""){$b1=0;}
if($b2==""){$b2=$bumon_end_key;}

//日報読込
$sql  = 'SELECT * FROM nippo WHERE';
$sql .= ' date>'.$m1.' and date<'.$m2;
$sql .= ' and bumon>='.$b1.' and bumon<='.$b2;
$sql .= ' ORDER BY date ASC';

$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
//while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
//	$kamoku[$row['no']]=$row['name'  ];
//	$bunrui[$row['no']]=$row['bunrui'];
//}

?>

<meta charset="utf-8"/>
echo '<link rel="stylesheet" href="table.css">';
echo '<link rel="stylesheet" href="simple.css">';

</head>
<body>

	<?
	  //選択フォームセット
	  echo '<form action="';
	  echo (empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
	  echo '" method="get">';

	  //期間開始（m1）
	  echo '<font size="-1"><select name="m1">';
	  write_period($m1,'00');
	  echo '</select>';

	  //期間開始（m2）
	  echo '～<select name="m2">';
	  write_period($m2,'99');
	  echo '</select>｜';

	  /////////////////////////////
	  // 選択用期間書出サブルーチン

	  function write_period($m2,$end){
	  	$y=14;$m=1;		// 開始年月
	  	$y2=date('y')+1;	// 終了年
	  	while($y<$y2){
	  		while($m<13){
	  			$i=sprintf('%02d',$y).sprintf('%02d',$m).$end;
	  			echo'<option value="'.$i.'"';
	  			if($m2==$i){echo' selected';}
	  			echo'>'.floor($i/100).'</option>';
	  			$m++;
	  		}
	  		$y++;$m=1;
	  	}
	  }
	  ////////////////////////////


/*
	  //分類（k）
	  echo '分類';
	  echo '<input type="radio" name="k" value="0" ';if($k==0){echo'checked';}echo'>全体';
	  echo '<input type="radio" name="k" value="1" ';if($k==1){echo'checked';}echo'>会社';
	  echo '<input type="radio" name="k" value="2" ';if($k==2){echo'checked';}echo'>部門';
	  echo '<input type="radio" name="k" value="3" ';if($k==3){echo'checked';}echo'>詳細';
		echo '｜';
*/
	  //部門 集計開始（b1）
	  echo '部門<select name="b1">';
	  foreach($bumon as $key => $value){
	  	echo'<option value="'.$key.'"';
	  	if($b1==$key){echo' selected';}
	  	echo'>'.$key.' '.$value.'</option>';
	  }
	  echo '</select>';

	  //部門 集計終了（b2）
	  echo '～<select name="b2">';
	  foreach($bumon as $key => $value){
	  	echo'<option value="'.$key.'"';
	  	if($b2==$key){echo' selected';}
	  	echo'>'.$key.' '.$value.'</option>';
	  }
	  echo '</select>';

	  echo'｜<input type="submit"></form>';



	  //タイトル表示
	  echo '＜ 日報 ＞';
	?>

<table border=1 class="sample">
    <tr>
    	<th bgcolor="lightgray">日付
    	<th bgcolor="lightgray">部門
    	<th bgcolor="lightgray">内容
    	<th bgcolor="lightgray">担当
    
<?
  //部門名書出し
    while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
        echo '<tr>';
    	echo '<td align="center">'.$row['date'];
    	echo '<td align="center">'.$bumon[$row['bumon']];
    	echo '<td>'.$row['note'];
    	echo '<td align="center">'.$tanto[$row['tanto']];
    }
?>
