<?php
// --------------------------------------------------------|サブルーチン読込 |----
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');
require_once(dirname(__FILE__).'/_read_subdep.php');			// 科目・部門を読込

// --------------------------------------------------------| データセット |-------
$m1 = $_GET['m1']; // 開始期間 yymmdd
$m2 = $_GET['m2']; // 終了期間 yymmdd
$k  = $_GET['k' ]; // 科目分類 xxx
$b1 = $_GET['b1']; // 開始部門 xxxxx
$b2 = $_GET['b2']; // 終了部門 xxxxx

// --------------------------------------------------------| 初期値セット |-------
if($m1==""){$m1=date('y').date('m').'00';}
if($m2==""){$m2=date('y').date('m').'99';}
if($k ==""){$k=0;}
if($b1==""){$b1=0;}
if($b2==""){$b2=$bumon_end_key;}

// --------------------------------------------------------| HTML 書き出し |-----
?>
<meta http-equiv="content-language" content="ja">
<meta charset="utf-8"/>
<link rel="stylesheet" href="_table_fix.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="_table.js"></script>
<!--<style>a{text-decoration: none;}</style>-->
<a href="./"><<</a>

<form action="<?=(empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']?>" method="get">
<?
//期間開始（m1）
echo '期間：<select name="m1">';
write_period($m1);
echo '</select>';

//期間開始（m2）
echo '～<select name="m2">';
write_period($m2);
echo '</select>';

/////////////////////////////
// 選択用期間書出サブルーチン

function write_period($m2){
	$y=14;$m=1;		// 開始年月
	$y2=date('y')+1;	// 終了年
	while($y<$y2){
		while($m<13){
			$i=sprintf('%02d',$y).sprintf('%02d',$m).'00';
			echo'<option value="'.$i.'"';
			if($m2==$i){echo' selected';}
			echo'>'.floor($i/100).'</option>';
			$m++;
		}
		$y++;$m=1;
	}
}
////////////////////////////

echo'</select><input type="submit">';

// タイトル行書出し
echo ' <a href="./"><--</a> ';
echo '＜ 現金預金残高推移 ＞</form>';
echo '<table border=1 class="sample">';
echo '<tr><td align="center">年月';
foreach($kamoku as $key => $value){
	if($key<>0){	// 諸口を飛ばす
		if($key>=150){break;}	// 現預金だけを表示
		echo'<td align="center"><font size="-1" color="gray">'.sprintf("%03d", $key);
		echo'<br><font color="black">'.$value;
	}
}
echo'<td align="center"><b>合　計<td align="center">増　減';


// 毎月書出し

$i  =$m1+99;
$m2+=    99;
$zenkei=0  ;

while($i<=$m2){

	$nengetu=floor($i/100)/100;
	echo'<tr><td align="right">'.preg_replace("/^(\d{2})(\d{2})(\d{2})$/", "$1.$2", $i);

	foreach($kamoku as $key => $value){
		if($key<>0){	// 諸口を飛ばす
			if($key>=150){break;}	// 現預金だけを表示

			//kari zan
			$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kari='.$key.' and date<='.$i;
            $prepare =  $dbh -> prepare($sql);
            $prepare -> execute();
			$row = $prepare -> fetch();
			$kari=$row['sum(kingaku)'];

			//kashi zan
			$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kashi='.$key.' and date<='.$i;
            $prepare =  $dbh -> prepare($sql);
            $prepare -> execute();
			$row = $prepare -> fetch();
			$kashi=$row['sum(kingaku)'];

			//zan
			$zan =$kari-$kashi;	// 科目残計算
			$kei+=$zan;		// 総合計計算

			// 科目残書出し
			$kaisi =$i-99;
			$syuryo=$i;
			echo'<td align="right">';
			echo'<a href="motocho.htm?';
			echo "m1=$kaisi&m2=$syuryo&k=$key&b1=0&b2=".$bumon_end_key;
			echo '">'.number_format($zan);
		}
	}

	// 月毎の合計金額書き出し
	echo'<td align="right"><b>'.number_format($kei);
	$zougen=$kei-$zenkei;
	if($i<>($m1+99)){
		echo'<td align="right">';
		if($zougen>0){echo'<font color="blue">';}else{echo'<font color="red">';}
		echo number_format($zougen);
	}else{
		echo'<td align="center">-';
	}
	$zenkei=$kei;
	$kei=0; // 合計リセット
	$i+=100;// 翌月へポインタを移動
	if(($i-floor($i/10000)*10000)>1299){$i+=8800;}	//12月の翌月を1月にする修正
}
