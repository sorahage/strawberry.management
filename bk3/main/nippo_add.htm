<?php
// --------------------------------------------------------|サブルーチン読込 |----
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');
require_once(dirname(__FILE__).'/_read_subdep.php');			// 科目・部門を読込

// --------------------------------------------------------| データセット |-------
$bmn		= $_GET['bumon'	];
$date 		= $_GET['date'		];
$note		= $_GET['note'		];
$tnt			= $_GET['tanto'	];

// --------------------------------------------------------| HTML 書き出し |-----
echo '<meta charset="utf-8"/>';
echo '<link rel="stylesheet" href="table.css">';
echo '<link rel="stylesheet" href="simple.css">';
echo '<style>a{text-decoration: none;}</style>';
echo '<a href="./"><<</a> '; // ホームリンク

// 登録チェック＞データ未完成の場合
if($note==''){echo 'データ入力中';


echo '<form action="';
echo (empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
echo '" method="get">';

echo '＜日報登録＞<br>';

//部門選択
echo '部門 <select name="bumon">';
foreach($bumon as $key => $value){
	echo '<option value="'.$key.'"';
	if($key==$bmn){echo ' selected';}
	echo '>'.$key.' '.$value.'</option>';
}
echo '</select><br>';

//日付
echo '日付 <input type="date" size="6" name="date" ';
if($date==''){$date=date('Y').'-'.date('m').'-'.date('d');}
echo 'value="'.$date.'"><br>';

//内容
echo '内容 <textarea rows="4" cols="40" name="note">';
if($note<>''){echo $note;}
echo '</textarea><br>';

//担当選択
echo '担当 <select name="tanto">';
foreach($tanto as $key => $value){
	echo '<option value="'.$key.'"';
	if($key==$tnt){echo ' selected';}
	echo '>'.$key.' '.$value.'</option>';
}
echo '</select><br>';

//登録
echo '<br><input type="submit" value="登録"><br>';



}else{

echo'o登録<br>';

// 日付変換
$date=str_replace( '-', '', $date);			// ハイフンを除く
$date=substr($date,2,6);	// 右から6文字を抜き出す

$sql  = 'INSERT INTO nippo ';
$sql .= '( bumon,date,note,tanto,`check` )';
$sql .= "values ( $bmn , $date , ? , $tnt , 0 )";
$prepare =  $dbh -> prepare($sql);
$prepare -> bindvalue(1,$note);
$prepare -> execute();

// 登録データ書出
echo '<table border=1 class="sample">';
echo '<tr>';
echo '<th bgcolor="lightgray" align="center">部門';
echo '<th bgcolor="lightgray" align="center">日付';
echo '<th bgcolor="lightgray" align="center">内容';
echo '<th bgcolor="lightgray" align="center">担当';

echo '<tr>';
echo '<td>'.$bmn.' '.$bumon[$bmn];
echo '<td>'.$date;
echo '<td>'.$note;
echo '<td>'.$tnt.' '.$tanto[$tnt];

echo '</table><a href="./nippo_add.htm">日報追加';
}
