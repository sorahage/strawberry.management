<?php
// --------------------------------------------------------|サブルーチン読込 |----
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');
require_once(dirname(__FILE__).'/_basic_data_read.php');	// 基本データ読込
require_once(dirname(__FILE__).'/_write_period.php');     // 期間選択サブルーチン

// --------------------------------------------------------| HTML 書き出し |-----
?>
<meta http-equiv="content-language" content="ja">
<meta charset="utf-8"/>
<link rel="stylesheet" href="_table_fix.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="_table.js"></script>

<?
// --------------------------------------------------------| 選択フォームセット |--
echo '<form action="';
echo (empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
echo '" method="get">';

echo '<a href="./"><<</a> '; // ホームリンク
echo '| 銀行残高推移 | 期間 ';

//期間選択
write_period('m1',$m1,'00');
echo '-';
write_period('m2',$m2,'99');

echo ' <input type="submit">';
echo '</form>';

// タイトル行書出し
echo '<table border=1 class="sample">';
echo '<tr><td align="center">年月';
foreach($kamoku as $key => $value){
	if($key<>0){	// 諸口を飛ばす
		if($key>=150){break;}	// 現預金だけを表示
		echo'<td align="center"><font size="-1" color="gray">'.sprintf("%03d", $key);
		echo'<br><font color="black">'.$value;
	}
}
echo'<td align="center"><b>合　計<td align="center">増　減';


// 毎月書出し

$i  =$m1+99;
$m2+=    99;
$zenkei=0  ;

while($i<=$m2){

	$nengetu=floor($i/100)/100;
	echo'<tr><td align="right">'.preg_replace("/^(\d{2})(\d{2})(\d{2})$/", "$1.$2", $i);

	foreach($kamoku as $key => $value){
		if($key<>0){	// 諸口を飛ばす
			if($key>=150){break;}	// 現預金だけを表示

			//kari zan
			$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kari='.$key.' and date<='.$i;
            $prepare =  $dbh -> prepare($sql);
            $prepare -> execute();
			$row = $prepare -> fetch();
			$kari=$row['sum(kingaku)'];

			//kashi zan
			$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kashi='.$key.' and date<='.$i;
            $prepare =  $dbh -> prepare($sql);
            $prepare -> execute();
			$row = $prepare -> fetch();
			$kashi=$row['sum(kingaku)'];

			//zan
			$zan =$kari-$kashi;	// 科目残計算
			$kei+=$zan;		// 総合計計算

			// 科目残書出し
			$kaisi =$i-99;
			$syuryo=$i;
			echo'<td align="right">';
			echo'<a href="motocho.htm?';
			echo "m1=$kaisi&m2=$syuryo&k=$key&b1=0&b2=".$bumon_end_key;
			echo '">'.number_format($zan);
		}
	}

	// 月毎の合計金額書き出し
	echo'<td align="right"><b>'.number_format($kei);
	$zougen=$kei-$zenkei;
	if($i<>($m1+99)){
		echo'<td align="right">';
		if($zougen>0){echo'<font color="blue">';}else{echo'<font color="red">';}
		echo number_format($zougen);
	}else{
		echo'<td align="center">-';
	}
	$zenkei=$kei;
	$kei=0; // 合計リセット
	$i+=100;// 翌月へポインタを移動
	if(($i-floor($i/10000)*10000)>1299){$i+=8800;}	//12月の翌月を1月にする修正
}
