<?php
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');

echo '<meta charset="utf-8"/>';
echo '<link rel="stylesheet" href="table.css">';
echo '<link rel="stylesheet" href="simple.css">';
echo '<style>a{text-decoration: none;}</style>';

//科目読込
$sql  = 'SELECT no,name,bunrui FROM kamoku WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$kamoku[$row['no']]=$row['name'  ];
	$bunrui[$row['no']]=$row['bunrui'];
}

//部門読込
$sql  = 'SELECT no,name FROM bumon WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$bumon[$row['no']]=$row['name'  ];
}
//end($bumon);
//$bumon_end_key=key($bumon);
//reset($bumon);


$bmn		= $_GET['bmn'		];
$date 		= $_GET['date'		];
$kari			= $_GET['kari'		];
$kashi		= $_GET['kashi'	];
$kingaku	= $_GET['kingaku'];
$tekiyou	= $_GET['tekiyou'	];

// 登録チェック＞データ未完成の場合
if($date=='' or $date==0 or ($kari==0 and $kashi==0) or $kingaku<1 or $tekiyou==''){echo 'データ入力中';


echo '<form action="';
echo (empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
echo '" method="get">';

echo '＜仕訳登録＞<br>';

//部門選択
echo '部門 <select name="bmn">';
foreach($bumon as $key => $value){
	echo '<option value="'.$key.'"';
	if($key==$bmn){echo ' selected';}
	echo '>'.$key.' '.$value.'</option>';
}
echo '</select><br>';

//日付
echo '日付 <input type="date" size="6" name="date" ';
if($date=='' or $date=='000000'){$date=date('Y').'-'.date('m').'-'.date('d');}
echo 'value="'.$date.'"><br>';

//借方
echo '借方 <select name="kari">';
foreach($kamoku as $key => $value){
	echo '<option value="'.$key.'"';
	if($key==$kari){echo ' selected';}
	echo '>'.$key.' '.$value.'</option>';
}
echo '</select><br>';

//貸方
echo '貸方 <select name="kashi">';
foreach($kamoku as $key => $value){
	echo '<option value="'.$key.'"';
	if($key==$kashi){echo ' selected';}
	echo '>'.$key.' '.$value.'</option>';
}
echo '</select><br>';

//金額
echo '金額 <input type="text" size="7" name="kingaku"';
if($kingaku<>'' and $kingaku>0){echo ' value="'.$kingaku.'"';}
echo '><br>';

//摘要
echo '摘要 <input type="text" size="24" name="tekiyou"';
if($tekiyou<>''){echo ' value="'.$tekiyou.'"';}
echo '><br>';

//登録
echo '<br><input type="submit" value="登録"><br>';

//定型仕訳表示
//定型読込
$sql  = 'SELECT * FROM teikei WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	echo '<a href="add.htm';
	echo '?bmn='.$row['bumon'];
	echo '&date='.$row['date'];
	echo '&kari='.$row['kari'];
	echo '&kashi='.$row['kashi'];
	echo '&kingaku='.$row['kingaku'];
	echo '&tekiyou='.$row['tekiyou'];
	echo '">'.$row['name'].'</a>|';
}

}else{

echo'o登録<br>';

// 日付変換
$date=str_replace( '-', '', $date);			// ハイフンを除く
$date=substr($date,2,6);	// 右から6文字を抜き出す

$sql  = 'INSERT INTO shiwake ';
$sql .= '( bumon,date,kari,kashi,kingaku,tekiyou,chk )';
$sql .= "values ( $bmn , $date , $kari , $kashi , $kingaku , '$tekiyou' , 0 )";
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);

// 登録データ書出
echo '<table border=1 class="sample">';
echo '<tr>';
echo '<th bgcolor="lightgray" align="center">部門';
echo '<th bgcolor="lightgray" align="center">日付';
echo '<th bgcolor="lightgray" align="center">借方';
echo '<th bgcolor="lightgray" align="center">貸方';
echo '<th bgcolor="lightgray" align="center">金額';
echo '<th bgcolor="lightgray" align="center">摘要';

echo '<tr>';
echo '<td>'.$bmn.' '.$bumon[$bmn];
echo '<td>'.$date;
echo '<td>'.$kari.' '.$kamoku[$kari];
echo '<td>'.$kashi.' '.$kamoku[$kashi];
echo '<td>'.$kingaku;
echo '<td>'.$tekiyou;

echo '</table><a href="./add.htm">追加仕訳';
}
