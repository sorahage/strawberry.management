<?php
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');

echo '<meta charset="utf-8"/>';

echo '<link rel="stylesheet" href="table.css">';
echo '<link rel="stylesheet" href="simple.css">';

$year=$_GET['y'];
$d=array(1,2,3,4,5,6,7,8,9,10,11,12,13);

//科目読込
$sql  = 'SELECT no,name,bunrui FROM kamoku WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$kamoku[$row['no']]=$row['name'  ];
	$bunrui[$row['no']]=$row['bunrui'];
}

//タイトル表示
echo ' <a href="./"><--</a> ';
echo '<t1>＜ 各月末残高一覧表 ＞<br>';
echo '<table border=1 class="sample"><tbody>';
echo '<th width=200 align="center">科　目';
echo '<th width=200 align="center">期　首';
foreach ($d as $d1) {echo '<th width=200 align="center">'.$d1;}
echo '<th width=200 align="center">期　末</tbody>';

foreach ($kamoku as $key => $value) {

	//預金計表示
	if($key>149 and $before_key<150){
		echo '<tr><td align="right"><b>預金計'.
		     '<td align="right"><b>'.number_format($yokin_kisyu);
		$yokin_zan=$yokin_kisyu;
		foreach ($d as $d1) {
			echo '<td align="right"><b>'.number_format($yokin_kei[$d1]);
			$yokin_zan+=$yokin_kei[$d1];
		}
		
		echo '<td align="right"><b>'.number_format($yokin_zan  );
	}

	echo '<tr><td>'.sprintf("%03d", $key).' '.$value;

	//期首金額を検索
	$sql  = 'SELECT kingaku FROM shiwake WHERE kari='.$key.' and date='.$year.'0000';
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kisyu=$row['kingaku'];
	if($key==0){$kisyu=0;}//諸口は貸方、借方に金額があり、集計差額を訂正

	//機首金額を表示
	echo '<td align="right">'.number_format($kisyu);
	$zan=$kisyu;
	$yokin_kisyu+=$kisyu;

	//1-13月を検索表示
	foreach ($d as $d1) {
		//echo '---'.$d1.'---';
		$sql  = 'SELECT kingaku FROM shiwake WHERE kari ='.$key.' and date='.$year.sprintf('%02d',$d1).'00';
		$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
		$row = mysql_fetch_array($result, MYSQL_ASSOC);
		$kari=$row['kingaku'];
	
		$sql  = 'SELECT kingaku FROM shiwake WHERE kashi='.$key.' and date='.$year.sprintf('%02d',$d1).'00';
		$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
		$row = mysql_fetch_array($result, MYSQL_ASSOC);
		$kashi=$row['kingaku'];
	
		if($bunrui[$key]>1 and $bunrui[$key]<5){
			$zougen=-$kari+$kashi;
		}else{
			$zougen=+$kari-$kashi;
		}

		// 現預金計
		if($key>001 and $key<150){
			$yokin_kei[$d1]+=$zougen;
		}

		echo '<td align="right">'.number_format($zougen);
		$zan+=$zougen;

	}

	echo '<td align="right">'.number_format($zan);

	// 直前の科目番号を代入
	$before_key=$key;

}

