<?php
require_once(dirname(__FILE__).'/../_init/_session_start.php');
require_once(dirname(__FILE__).'/../_init/_login_check.php');
require_once(dirname(__FILE__).'/../_init/_sql_init.php');

echo '<link rel="stylesheet" href="table.css">';
echo '<link rel="stylesheet" href="simple.css">';


//科目読込
$sql  = 'SELECT no,name,bunrui FROM kamoku WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$kamoku[$row['no']]=$row['name'  ];
	$bunrui[$row['no']]=$row['bunrui'];
}

//部門読込
$sql  = 'SELECT no,name FROM bumon WHERE 1 ORDER BY no ASC';
$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
while ( $row = mysql_fetch_array($result, MYSQL_ASSOC)) {
	$bumon[$row['no']]=$row['name'  ];
}


//選択メニュー表示
$y=15; $m=1;
while($y<17){
	echo '<a href="?y='.$y.'&d=0">20'.$y.'</a> | ';
	while($m<14){
		echo '<a href="?y='.$y.'&d='.$m.'">'.$m.'月</a> ';
		$m++;
	}
	$y++;$m=1;
	echo '<br><br>';

}


echo '<a href="?d=-1">法人集計 1509-0608</a><br><br>';

//form送信
echo '<form action="';
echo (empty($_SERVER['HTTPS']) ? 'http://' : 'https://').$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
echo '" method="post">';

//部門選択表示　開始
$b1=$_POST['bumon1'];
$b2=$_POST['bumon2'];

echo '部門開始：<select name="bumon1">';

foreach($bumon as $key => $value){
	echo'<option value="'.$key.'"';
	if($b1==$key){echo' selected';}
	echo'>'.$key.' '.$value.'</option>';
}
echo'</select>';
//部門選択表示　終了

echo '部門終了：<select name="bumon2">';

foreach($bumon as $key => $value){
	echo'<option value="'.$key.'"';
	if($b2==$key){echo' selected';}
	echo'>'.$key.' '.$value.'</option>';
}
echo'</select>';
//部門選択表示　終了

echo'</select><input name="Go" type="submit"></form>';


//データセット
$year=$_GET['y'];
$d=$_GET['d'];

if($year==0){$year=16;}

$date1=$year*10000+$d*100;
$date2=$date1+99;
//$date2=$date1;
if($d==0){$date1=$year*10000+100;$date2=$date1+1200;}
echo $date1.'-'.$date2;
//if($d==-1){$date1=150900;$date2=160900;}

echo ' <a href="./"><--</a> ';
echo '＜ '.floor($date1/100).'-'.floor($date2/100).' 試算表 ＞<br>';
echo '<table border=1 class="sample">';

//金額リセット
$yokin=0;

foreach ($kamoku as $key => $value) {

	if($key>149 and $before_key<150){
		echo '<tr><td align="right"><b>預金計'.
		     '<td align="right"><b>'.number_format($yokin_kisyu).
		     '<td align="right"><b>'.number_format($yokin_kari ).
		     '<td align="right"><b>'.number_format($yokin_kashi).
		     '<td align="right"><b>'.number_format($yokin_zan  );
	}

	echo '<tr><td>'.sprintf("%03d", $key).' '.$value;

	//期首残読込
	$d0=floor($date1/100)-1;//前月末の残高を取得
	if($d<2){$d0-=87;}	//1月の場合は前年末の残高を取得
	echo'['.$d0.']';
	$sql  = 'SELECT sum(kingaku) FROM zan WHERE kamoku='.$key.' and date='.$d0.' and bumon>='.$b1.' and bumon<='.$b2;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kisyu=$row['sum(kingaku)'];

	//期末残読込
	$d0=floor($date2/100);
	echo'['.$d0.']';
	$sql  = 'SELECT sum(kingaku) FROM zan WHERE kamoku='.$key.' and date='.$d0.' and bumon='.$b1.' and bumon<='.$b2;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$zan=$row['sum(kingaku)'];

	//借方集計
	$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kari ='.$key.' and date>'.$date1.' and date<'.$date2.' and bumon='.$b1.' and bumon<='.$b2;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kari=$row['sum(kingaku)'];	

	//貸方集計
	$sql  = 'SELECT sum(kingaku) FROM shiwake WHERE kashi='.$key.' and date>'.$date1.' and date<'.$date2.' and bumon='.$b1.' and bumon<='.$b2;
	$result = mysql_query($sql, $link) or die("クエリの送信に失敗しました。<br />SQL:".$sql);
	$row = mysql_fetch_array($result, MYSQL_ASSOC);
	$kashi=$row['sum(kingaku)'];

	/*
	if($bunrui[$key]>1 and $bunrui[$key]<5){
		$zan=$kisyu-$kari+$kashi;
	}else{
		$zan=$kisyu+$kari-$kashi;
	}
	*/

	// 現預金計
	if($key>001 and $key<150){
		$yokin_kisyu+=$kisyu;
		$yokin_kari +=$kari ;
		$yokin_kashi+=$kashi;
		$yokin_zan  +=$zan  ;
	}

	echo '<td align="right">'.number_format($kisyu).'<td align="right">'.number_format($kari).
	     '<td align="right">'.number_format($kashi).'<td align="right">'.number_format($zan );

	// 直前の科目番号を代入
	$before_key=$key;
	//echo'<td>'.$before_key;
}

